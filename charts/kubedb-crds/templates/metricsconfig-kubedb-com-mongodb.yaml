apiVersion: metrics.appscode.com/v1alpha1
kind: MetricsConfiguration
metadata:
  name: kubedb-com-mongodb
spec:
  targetRef:
    apiVersion: kubedb.com/v1alpha2
    kind: MongoDB
  metrics:
    - name: kubedb_mongodb_created
      help: "Unix creation timestamp"
      type: gauge
      field:
        path: .metadata.creationTimestamp
        type: DateTime
      metricValue:
        valueFromPath: .metadata.creationTimestamp

    - name: kubedb_mongodb_replicaset_info
      help: "Kubedb mongodb replicaset information"
      type: gauge
      labels:
        - key: replicas
          valuePath: .spec.replicas
        - key: cpu_request
          valuePath: .spec.podTemplate.spec.resources.requests.cpu
        - key: cpu_limit
          valuePath: .spec.podTemplate.spec.resources.limits.cpu
        - key: memory_request
          valuePath: .spec.podTemplate.spec.resources.requests.memory
        - key: memory_limit
          valuePath: .spec.podTemplate.spec.resources.limits.memory
      metricValue:
        valueFromPath: .spec.replicas

    - name: kubedb_mongodb_replicaset_storage_bytes
      help: "Kubedb mongodb available storage size in bytes"
      type: gauge
      labels:
        - key: unit
          value: bytes
      params:
        - key: storage
          valuePath: .spec.storage.resources.requests.storage
      metricValue:
        valueFromExpression: "bytes(storage)"

    - name: kubedb_mongodb_status_phase
      help: "MongoDB instance current phase"
      type: gauge
      field:
        path: .status.phase
        type: String
      params:
        - key: phase
          valuePath: .status.phase
      states:
        labelKey: phase
        values:
          - labelValue: Ready
            metricValue:
              valueFromExpression: "int(phase == 'Ready')"
          - labelValue: Halted
            metricValue:
              valueFromExpression: "int(phase == 'Halted')"
          - labelValue: Provisioning
            metricValue:
              valueFromExpression: "int(phase == 'Provisioning')"
          - labelValue: Critical
            metricValue:
              valueFromExpression: "int(phase == 'Critical')"
          - labelValue: NotReady
            metricValue:
              valueFromExpression: "int(phase == 'NotReady')"
          - labelValue: DataRestoring
            metricValue:
              valueFromExpression: "int(phase == 'DataRestoring')"

    - name: kubedb_mongodb_info
      help: "MongoDB instance information"
      type: gauge
      labels:
        - key: clusterAuthMode
          valuePath: .spec.clusterAuthMode
        - key: sslMode
          valuePath: .spec.sslMode
        - key: storageType
          valuePath: .spec.storageType
        - key: terminationPolicy
          valuePath: .spec.terminationPolicy
        - key: version
          valuePath: .spec.version
      metricValue:
        value: 1

    - name: kubedb_mongodb_status_conditions
      help: "MongoDB instance status condition"
      type: gauge
      field:
        path: .status.conditions
        type: Array
      labels:
        - key: type
          valuePath: .status.conditions[*].type
        - key: status
          valuePath: .status.conditions[*].status
      metricValue:
        value: 1

    - name: kubedb_mongodb_shard_enabled
      help: "MongoDB sharded topology enable info"
      type: gauge
      params:
        - key: topology
          valuePath: .spec.shardTopology
      metricValue:
        valueFromExpression: "int(topology != 'nil')"

    ##### Metrics config for mongodb sharded database #####

    - name: kubedb_mongodb_shard_shards
      help: "Number of shards of the MongoDB database"
      type: gauge
      field:
        path: .spec.shardTopology.shard.shards
        type: Integer
      metricValue:
        valueFromPath: .spec.shardTopology.shard.shards

    - name: kubedb_mongodb_shard_replicas
      help: "Number of replicas in the MongoDB shards"
      type: gauge
      field:
        path: .spec.shardTopology.shard.replicas
        type: Integer
      metricValue:
        valueFromPath: .spec.shardTopology.shard.replicas

    - name: kubedb_mongodb_shard_info
      help: "MongoDB sharded database information"
      type: gauge
      labels:
        - key: cpu_request
          valuePath: .spec.shardTopology.shard.podTemplate.spec.resources.requests.cpu
        - key: cpu_limit
          valuePath: .spec.shardTopology.shard.podTemplate.spec.resources.limits.cpu
        - key: memory_request
          valuePath: .spec.shardTopology.shard.podTemplate.spec.resources.requests.memory
        - key: memory_limit
          valuePath: .spec.shardTopology.shard.podTemplate.spec.resources.limits.memory
        - key: storage_classname
          valuePath: .spec.shardTopology.shard.storage.storageClassName
      metricValue:
        value: 1

    - name: kubedb_mongodb_shard_storage_bytes
      help: "Available storage for MongoDB shards"
      type: gauge
      params:
        - key: storage
          valuePath: .spec.shardTopology.shard.storage.resources.requests.storage
      metricValue:
        valueFromExpression: bytes(storage)

    - name: kubedb_mongodb_configsvr_info
      help: "MongoDB sharded database config server information"
      type: gauge
      labels:
        - key: cpu_request
          valuePath: .spec.shardTopology.configServer.podTemplate.spec.resources.requests.cpu
        - key: cpu_limit
          valuePath: .spec.shardTopology.configServer.podTemplate.spec.resources.limits.cpu
        - key: memory_request
          valuePath: .spec.shardTopology.configServer.podTemplate.spec.resources.requests.memory
        - key: memory_limit
          valuePath: .spec.shardTopology.configServer.podTemplate.spec.resources.limits.memory
        - key: storage_classname
          valuePath: .spec.shardTopology.configServer.storage.storageClassName
      metricValue:
        value: 1

    - name: kubedb_mongodb_configsvr_replicas
      help: "Number of replicas in MongoDB config server in sharded database"
      type: gauge
      field:
        path: .spec.shardTopology.configServer.replicas
        type: Integer
      metricValue:
        valueFromPath: .spec.shardTopology.configServer.replicas

    - name: kubedb_mongodb_configsvr_storage_bytes
      help: "Available storage for MongoDB config server"
      type: gauge
      params:
        - key: storage
          valuePath: .spec.shardTopology.configServer.storage.resources.requests.storage
      metricValue:
        valueFromExpression: bytes(storage)

    - name: kubedb_mongodb_mongos_info
      help: "MongoDB sharded database mongos info"
      type: gauge
      labels:
        - key: cpu_request
          valuePath: .spec.shardTopology.mongos.podTemplate.spec.resources.requests.cpu
        - key: cpu_limit
          valuePath: .spec.shardTopology.mongos.podTemplate.spec.resources.limits.cpu
        - key: memory_request
          valuePath: .spec.shardTopology.mongos.podTemplate.spec.resources.requests.memory
        - key: memory_limit
          valuePath: .spec.shardTopology.mongos.podTemplate.spec.resources.limits.memory
      metricValue:
        value: 1

    - name: kubedb_mongodb_mongos_replicas
      help: "Number of replicas in mongodb sharded mongos"
      type: gauge
      field:
        path: .spec.shardTopology.mongos.replicas
        type: Integer
      metricValue:
        valueFromPath: .spec.shardTopology.mongos.replicas
